[
    {
        "id": "eee4d6c3c137bc07",
        "type": "tab",
        "label": "ChineseVersion",
        "disabled": false,
        "info": ""
    },
    {
        "id": "0b77d9a9b20742b9",
        "type": "e-mail in",
        "z": "eee4d6c3c137bc07",
        "name": "IMAPç›‘å¬é‚®ä»¶",
        "protocol": "IMAP",
        "server": "imap.gmail.com",
        "useSSL": true,
        "autotls": "never",
        "port": "993",
        "authtype": "BASIC",
        "saslformat": false,
        "token": "YOUR_OAUTH_ACCESS_TOKEN_HERE",
        "box": "INBOX",
        "disposition": "Read",
        "criteria": "UNSEEN",
        "repeat": "30",
        "fetch": "auto",
        "inputs": 0,
        "x": 430,
        "y": 480,
        "wires": [
            [
                "3fd55876cde28b6d"
            ]
        ]
    },
    {
        "id": "3fd55876cde28b6d",
        "type": "function",
        "z": "eee4d6c3c137bc07",
        "name": "å¤„ç†é‚®ä»¶å†…å®¹",
        "func": "// æå–é‚®ä»¶å…³é”®ä¿¡æ¯\nconst emailData = {\n    from: msg.from || 'æœªçŸ¥å‘ä»¶äºº',\n    to: msg.to || 'æœªçŸ¥æ”¶ä»¶äºº', \n    subject: msg.subject || 'æ— ä¸»é¢˜',\n    text: msg.text || msg.payload || 'æ— å†…å®¹',\n    date: msg.date || new Date().toISOString(),\n    messageId: msg.messageId || 'unknown'\n};\n\n// æ„å»ºç»™DeepSeekçš„æç¤ºè¯ï¼Œå¼ºè°ƒå½“å‰é‚®ä»¶ä¼˜å…ˆçº§\nconst prompt = `è¯·åˆ†æä»¥ä¸‹é‚®ä»¶ï¼Œé‡ç‚¹å…³æ³¨æœ€æ–°å‘é€çš„å†…å®¹ï¼Œå†å²å¾€æ¥ä»…ä½œä¸ºç†è§£ä¸Šä¸‹æ–‡çš„å‚è€ƒï¼š\n\nğŸ“§ é‚®ä»¶è¯¦æƒ…ï¼š\nå‘ä»¶äººï¼š${emailData.from}\næ”¶ä»¶äººï¼š${emailData.to}\nä¸»é¢˜ï¼š${emailData.subject}\nå‘é€æ—¶é—´ï¼š${emailData.date}\nå®Œæ•´å†…å®¹ï¼š${emailData.text}\n\nğŸ¯ åˆ†æé‡ç‚¹ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š\n1. **å½“å‰é‚®ä»¶æ ¸å¿ƒå†…å®¹**ï¼šé‡ç‚¹åˆ†æå‘ä»¶äººåœ¨è¿™å°é‚®ä»¶ä¸­çš„æœ€æ–°æ„å›¾å’Œéœ€æ±‚\n2. **å†å²ä¸Šä¸‹æ–‡å‚è€ƒ**ï¼šåˆ©ç”¨å†å²å¾€æ¥ç†è§£èƒŒæ™¯ï¼Œä½†ä¸è¦è®©å†å²å†…å®¹å¹²æ‰°å¯¹å½“å‰é‚®ä»¶çš„åˆ¤æ–­\n3. **æ—¶æ•ˆæ€§åˆ¤æ–­**ï¼šä¼˜å…ˆè¯†åˆ«å½“å‰é‚®ä»¶ä¸­éœ€è¦ç«‹å³å¤„ç†çš„äº‹é¡¹\n\nğŸ“‹ è¯·æä¾›ä»¥ä¸‹åˆ†æï¼Œå‡åœ¨30å­—ä»¥å†…ï¼š\n1. ã€æ„å›¾åˆ†æã€‘ï¼šé‚®ä»¶çš„ä¸»è¦ç›®çš„å’Œå‘ä»¶äººçš„çœŸå®éœ€æ±‚\n2. ã€å…³é”®ä¿¡æ¯ã€‘ï¼šéœ€è¦é‡ç‚¹å…³æ³¨çš„è¦ç‚¹ï¼Œæ¯”å¦‚æ—¶é—´ã€åœ°ç‚¹ã€äººç‰©ç­‰\n3. ã€å»ºè®®å›å¤ã€‘ï¼šæä¾›å…·ä½“çš„å›å¤å†…å®¹ï¼ˆç®€æ´ã€ä¸“ä¸šã€æœ‰é’ˆå¯¹æ€§ï¼‰\n\nè¯·ç”¨ä¸­æ–‡å›å¤ï¼Œä¿æŒç®€æ´ä¸“ä¸šå’Œå®ç”¨æ€§ï¼Œä¸å¤šè¯´ä¸€å¥åºŸè¯ã€‚\nâš ï¸ é‡è¦ï¼šè¯·ç¡®ä¿æ‰€æœ‰åˆ†æéƒ½ä»¥å½“å‰é‚®ä»¶ä¸ºä¸»ï¼Œå†å²ä¿¡æ¯ä»…ç”¨äºè¡¥å……ç†è§£èƒŒæ™¯ã€‚`;\n\n// ä¿å­˜åŸå§‹é‚®ä»¶ä¿¡æ¯\nmsg.originalEmail = emailData;\nmsg.analysisPrompt = prompt;\n\n// æ·»åŠ æ—¥å¿—\nnode.log(`æ”¶åˆ°æ–°é‚®ä»¶ - å‘ä»¶äºº: ${emailData.from}, ä¸»é¢˜: ${emailData.subject}`);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 650,
        "y": 480,
        "wires": [
            [
                "7a21f4cdc4eb3f2b"
            ]
        ]
    },
    {
        "id": "7a21f4cdc4eb3f2b",
        "type": "function",
        "z": "eee4d6c3c137bc07",
        "name": "æ„å»ºDeepSeekè¯·æ±‚",
        "func": "// è®¾ç½®ä½ çš„DeepSeek API Key\nconst API_KEY = \"YOUR_DEEPSEEK_API_KEY_HERE\"; // è¯·æ›¿æ¢ä¸ºä½ çš„å®é™…API Key\n\n// æ„å»ºè¯·æ±‚å¤´\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Authorization\": `Bearer ${API_KEY}`\n};\n\n// æ„å»ºè¯·æ±‚ä½“\nmsg.payload = {\n    \"model\": \"deepseek-chat\",\n    \"messages\": [\n        {\n            \"role\": \"system\",\n            \"content\": \"ä½ æ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œä¸”éå¸¸ä¼šæŠ“é‡ç‚¹çš„é‚®ä»¶å¤„ç†ä¸“å®¶å’Œå•†åŠ¡æ²Ÿé€šé¡¾é—®ï¼Œä½ æ“…é•¿å¿«é€Ÿç†è§£é‚®ä»¶æ„å›¾ï¼Œå¹¶æä¾›å¾—ä½“ã€é«˜æ•ˆçš„å›å¤å»ºè®®ï¼Œé‚®ä»¶å¯èƒ½ç”¨ä¸­æ–‡/è‹±æ–‡æ’°å†™ï¼Œä½†ä½ éœ€è¦ç»Ÿä¸€åˆ†ææˆä¸­æ–‡çš„ç»™æˆ‘\"\n        },\n        {\n            \"role\": \"user\",\n            \"content\": msg.analysisPrompt\n        }\n    ],\n    \"max_tokens\": 1000,\n    \"temperature\": 0.2\n};\n\n// è®¾ç½®è¯·æ±‚æ–¹æ³•å’ŒURL\nmsg.method = \"POST\";\nmsg.url = \"https://api.deepseek.com/v1/chat/completions\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 480,
        "wires": [
            [
                "69af0245fa561aa6"
            ]
        ]
    },
    {
        "id": "69af0245fa561aa6",
        "type": "http request",
        "z": "eee4d6c3c137bc07",
        "name": "è°ƒç”¨DeepSeek API",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1130,
        "y": 480,
        "wires": [
            [
                "c728a18f0d7ca7b2"
            ]
        ]
    },
    {
        "id": "c728a18f0d7ca7b2",
        "type": "function",
        "z": "eee4d6c3c137bc07",
        "name": "å¤„ç†AIåˆ†æç»“æœ",
        "func": "// æ£€æŸ¥å“åº”çŠ¶æ€\nif (msg.statusCode !== 200) {\n    msg.payload = {\n        error: true,\n        statusCode: msg.statusCode,\n        message: \"AIåˆ†æå¤±è´¥\",\n        originalEmail: msg.originalEmail,\n        timestamp: new Date().toISOString()\n    };\n    node.error(`APIè°ƒç”¨å¤±è´¥: ${msg.statusCode}`);\n    return msg;\n}\n\n// æå–AIåˆ†æç»“æœ\nif (msg.payload && msg.payload.choices && msg.payload.choices.length > 0) {\n    const aiAnalysis = msg.payload.choices[0].message.content;\n    \n    // æ„å»ºæœ€ç»ˆç»“æœ\n    msg.payload = {\n        success: true,\n        timestamp: new Date().toISOString(),\n        emailSummary: {\n            from: msg.originalEmail.from,\n            subject: msg.originalEmail.subject,\n            preview: msg.originalEmail.text.substring(0, 150) + (msg.originalEmail.text.length > 150 ? '...' : ''),\n            date: msg.originalEmail.date,\n            messageId: msg.originalEmail.messageId\n        },\n        fullEmailContent: msg.originalEmail.text,\n        aiAnalysis: aiAnalysis,\n        tokenUsage: msg.payload.usage || {}\n    };\n    \n    // è®¾ç½®é€šçŸ¥æ ‡é¢˜\n    msg.topic = `ğŸ“§ æ–°é‚®ä»¶AIåˆ†æå®Œæˆ - ${msg.originalEmail.subject}`;\n    \n    node.log(`AIåˆ†æå®Œæˆ - é‚®ä»¶: ${msg.originalEmail.subject}`);\n    \n} else {\n    msg.payload = {\n        error: true,\n        message: \"AIå“åº”æ ¼å¼å¼‚å¸¸\",\n        originalEmail: msg.originalEmail,\n        rawResponse: msg.payload\n    };\n    node.error(\"AIå“åº”æ ¼å¼å¼‚å¸¸\");\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1390,
        "y": 480,
        "wires": [
            [
                "20fdc53bb8c67f47",
                "341722b326f9b29d"
            ]
        ]
    },
    {
        "id": "341722b326f9b29d",
        "type": "function",
        "z": "eee4d6c3c137bc07",
        "name": "æ„å»ºæå–è¯·æ±‚",
        "func": "// åªå¤„ç†æˆåŠŸçš„åˆ†æç»“æœ\nif (!msg.payload.success) {\n    return null;\n}\n\n// ä¿å­˜åŸå§‹åˆ†æç»“æœ\nmsg.originalAnalysis = msg.payload;\n\n// è®¾ç½®ä½ çš„DeepSeek API Key\nconst API_KEY = \"YOUR_DEEPSEEK_API_KEY_HERE\"; // è¯·æ›¿æ¢ä¸ºä½ çš„å®é™…API Key\n\n// æ„å»ºè¯·æ±‚å¤´\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Authorization\": `Bearer ${API_KEY}`\n};\n\n// æ„å»ºä¸“é—¨æå–æ„å›¾å’Œè¡ŒåŠ¨çš„æç¤ºè¯\nconst extractPrompt = `è¯·ä»ä»¥ä¸‹é‚®ä»¶åˆ†æç»“æœä¸­ï¼Œæå–æœ€æ ¸å¿ƒçš„ä¸‰ä¸ªä¿¡æ¯ï¼š\n\n${msg.payload.aiAnalysis}\n\nè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–å†…å®¹ï¼š\næ„å›¾ï¼š[ä¸€å¥è¯æ¦‚æ‹¬é‚®ä»¶çš„çœŸå®æ„å›¾]\nå…³é”®ä¿¡æ¯ï¼š[éœ€è¦é‡ç‚¹å…³æ³¨çš„è¦ç‚¹ï¼Œæ¯”å¦‚æ—¶é—´ã€åœ°ç‚¹ã€äººç‰©ç­‰]\nè¡ŒåŠ¨ï¼š[ä¸€å¥è¯è¯´æ˜æˆ‘åº”è¯¥æ€ä¹ˆåš]\n\nè¦æ±‚ï¼š\n- æ¯æ¡ä¸è¶…è¿‡30ä¸ªå­—\n- ç›´æ¥ç»™å‡ºç»“è®ºï¼Œä¸è¦è§£é‡Š\n- ç”¨æœ€ç®€æ´çš„ä¸­æ–‡è¡¨è¾¾`;\n\n// æ„å»ºè¯·æ±‚ä½“\nmsg.payload = {\n    \"model\": \"deepseek-chat\",\n    \"messages\": [\n        {\n            \"role\": \"system\",\n            \"content\": \"ä½ æ˜¯ä¿¡æ¯æå–ä¸“å®¶ï¼Œæ“…é•¿ä»å¤æ‚æ–‡æœ¬ä¸­æå–å…³é”®ä¿¡æ¯å¹¶ç”¨æœ€ç®€æ´çš„è¯­è¨€è¡¨è¾¾ã€‚\"\n        },\n        {\n            \"role\": \"user\",\n            \"content\": extractPrompt\n        }\n    ],\n    \"max_tokens\": 200,\n    \"temperature\": 0.1\n};\n\n// è®¾ç½®è¯·æ±‚æ–¹æ³•å’ŒURL\nmsg.method = \"POST\";\nmsg.url = \"https://api.deepseek.com/v1/chat/completions\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1650,
        "y": 480,
        "wires": [
            [
                "9149a89943e46f51"
            ]
        ]
    },
    {
        "id": "9149a89943e46f51",
        "type": "http request",
        "z": "eee4d6c3c137bc07",
        "name": "è°ƒç”¨æå–API",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1850,
        "y": 480,
        "wires": [
            [
                "6fbf7ac62636d5b5"
            ]
        ]
    },
    {
        "id": "6fbf7ac62636d5b5",
        "type": "function",
        "z": "eee4d6c3c137bc07",
        "name": "å¤„ç†æå–ç»“æœ",
        "func": "// æ£€æŸ¥å“åº”çŠ¶æ€\nif (msg.statusCode !== 200) {\n    // æå–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼\n    msg.payload = {\n        intent: \"é‚®ä»¶éœ€è¦å¤„ç†\",\n        keyInfo: \"æŸ¥çœ‹è¯¦ç»†å†…å®¹\",\n        action: \"æŸ¥çœ‹è¯¦ç»†åˆ†æ\"\n    };\n    node.warn(\"AIæå–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼\");\n} else if (msg.payload && msg.payload.choices && msg.payload.choices.length > 0) {\n    const extractedText = msg.payload.choices[0].message.content.trim();\n\n    // è§£æAIæå–çš„ç»“æœ\n    let intent = \"é‚®ä»¶éœ€è¦å¤„ç†\";\n    let keyInfo = \"æŸ¥çœ‹è¯¦ç»†å†…å®¹\";\n    let action = \"æŸ¥çœ‹è¯¦ç»†åˆ†æ\";\n\n    // æå–æ„å›¾\n    const intentMatch = extractedText.match(/æ„å›¾[ï¼š:](.+?)(?=\\n|å…³é”®ä¿¡æ¯|è¡ŒåŠ¨|$)/s);\n    if (intentMatch) {\n        intent = intentMatch[1].trim();\n    }\n\n    // æå–å…³é”®ä¿¡æ¯\n    const keyInfoMatch = extractedText.match(/å…³é”®ä¿¡æ¯[ï¼š:](.+?)(?=\\n|è¡ŒåŠ¨|$)/s);\n    if (keyInfoMatch) {\n        keyInfo = keyInfoMatch[1].trim();\n    }\n\n    // æå–è¡ŒåŠ¨\n    const actionMatch = extractedText.match(/è¡ŒåŠ¨[ï¼š:](.+?)(?=\\n|$)/s);\n    if (actionMatch) {\n        action = actionMatch[1].trim();\n    }\n\n    msg.payload = {\n        intent: intent,\n        keyInfo: keyInfo,\n        action: action,\n        extractedText: extractedText\n    };\n} else {\n    // å“åº”æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨é»˜è®¤å€¼\n    msg.payload = {\n        intent: \"é‚®ä»¶éœ€è¦å¤„ç†\",\n        keyInfo: \"æŸ¥çœ‹è¯¦ç»†å†…å®¹\",\n        action: \"æŸ¥çœ‹è¯¦ç»†åˆ†æ\"\n    };\n    node.warn(\"AIå“åº”æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨é»˜è®¤å€¼\");\n}\n\n// æ¢å¤åŸå§‹æ•°æ®ç”¨äºåç»­å¤„ç†\nmsg.emailSummary = msg.originalAnalysis.emailSummary;\nmsg.fullAnalysis = msg.originalAnalysis.aiAnalysis;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2050,
        "y": 480,
        "wires": [
            [
                "a06ab672cbedbcd4",
                "a19860455ae64b23"
            ]
        ]
    },
    {
        "id": "a06ab672cbedbcd4",
        "type": "function",
        "z": "eee4d6c3c137bc07",
        "name": "ä¿å­˜å†å²è®°å½•",
        "func": "// æ„å»ºå†å²è®°å½•\nconst historyRecord = {\n    id: Date.now().toString(),\n    timestamp: new Date().toISOString(),\n    date: new Date().toLocaleString('zh-CN'),\n    emailInfo: {\n        from: msg.emailSummary.from,\n        subject: msg.emailSummary.subject,\n        preview: msg.emailSummary.preview,\n        messageId: msg.emailSummary.messageId\n    },\n    analysis: {\n        intent: msg.payload.intent || 'æœªåˆ†æ',\n        keyInfo: msg.payload.keyInfo || 'æ— å…³é”®ä¿¡æ¯',\n        action: msg.payload.action || 'æ— è¡ŒåŠ¨å»ºè®®'\n    },\n    fullAnalysis: msg.fullAnalysis || 'å®Œæ•´åˆ†æä¸å¯ç”¨'\n};\n\n// è·å–ç°æœ‰å†å²è®°å½•\nlet emailHistory = context.get('emailHistory') || [];\n\n// æ·»åŠ æ–°è®°å½•åˆ°å¼€å¤´\nemailHistory.unshift(historyRecord);\n\n// è·å–ç”¨æˆ·è®¾ç½®çš„ä¿ç•™æ•°é‡ï¼Œé»˜è®¤30æ¡\nconst maxRecords = global.get('emailHistoryLimit') || 30;\n\n// ä¿æŒæŒ‡å®šæ•°é‡çš„è®°å½•\nif (emailHistory.length > maxRecords) {\n    emailHistory = emailHistory.slice(0, maxRecords);\n}\n\n// ä¿å­˜æ›´æ–°åçš„å†å²\ncontext.set('emailHistory', emailHistory);\n\n// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯\nlet stats = context.get('emailStats') || { totalProcessed: 0, lastUpdate: null };\nstats.totalProcessed += 1;\nstats.lastUpdate = new Date().toISOString();\ncontext.set('emailStats', stats);\n\n// è®¾ç½®èŠ‚ç‚¹çŠ¶æ€æ˜¾ç¤º\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `å·²ä¿å­˜ ${emailHistory.length}/${maxRecords} æ¡è®°å½•`\n});\n\n// æ—¥å¿—è®°å½•\nnode.log(`å†å²è®°å½•å·²ä¿å­˜ - å½“å‰å…±${emailHistory.length}æ¡è®°å½•`);\n\n// ä¼ é€’æ•°æ®ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\nmsg.historyInfo = {\n    saved: true,\n    recordId: historyRecord.id,\n    totalRecords: emailHistory.length,\n    historyRecord: historyRecord\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2280,
        "y": 420,
        "wires": [
            [
                "9dbb2a6ec3cdae6f"
            ]
        ]
    },
    {
        "id": "9dbb2a6ec3cdae6f",
        "type": "debug",
        "z": "eee4d6c3c137bc07",
        "name": "ğŸ“š å†å²è®°å½•çŠ¶æ€",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "historyInfo",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2500,
        "y": 420,
        "wires": []
    },
    {
        "id": "20fdc53bb8c67f47",
        "type": "debug",
        "z": "eee4d6c3c137bc07",
        "name": "ğŸ“§ å®Œæ•´åˆ†æç»“æœ",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1670,
        "y": 400,
        "wires": []
    },
    {
        "id": "a19860455ae64b23",
        "type": "function",
        "z": "eee4d6c3c137bc07",
        "name": "å‡†å¤‡ç½‘é¡µæ•°æ®",
        "func": "// æ„å»ºé‚®ä»¶é€šçŸ¥æ•°æ®\nconst intent = msg.payload.intent || \"é‚®ä»¶éœ€è¦å¤„ç†\";\nconst keyInfo = msg.payload.keyInfo || \"æŸ¥çœ‹è¯¦ç»†å†…å®¹\";\nconst action = msg.payload.action || \"æŸ¥çœ‹è¯¦ç»†åˆ†æ\";\nconst from = msg.emailSummary.from || \"æœªçŸ¥å‘ä»¶äºº\";\nconst subject = msg.emailSummary.subject || \"æ— ä¸»é¢˜\";\nconst preview = msg.emailSummary.preview || \"æ— å†…å®¹é¢„è§ˆ\";\n\n// æ„å»ºé€šçŸ¥å¯¹è±¡\nconst notification = {\n    id: Date.now(),\n    timestamp: new Date().toISOString(),\n    displayTime: new Date().toLocaleString('zh-CN'),\n    from: from,\n    subject: subject,\n    preview: preview,\n    analysis: {\n        intent: intent,\n        keyInfo: keyInfo,\n        action: action\n    },\n    status: 'unread'\n};\n\n// è·å–ç°æœ‰é€šçŸ¥\nlet notifications = global.get('emailNotifications') || [];\n\n// æ·»åŠ æ–°é€šçŸ¥åˆ°å¼€å¤´\nnotifications.unshift(notification);\n\n// ä¿æŒæœ€è¿‘20æ¡é€šçŸ¥\nif (notifications.length > 20) {\n    notifications = notifications.slice(0, 20);\n}\n\n// ä¿å­˜é€šçŸ¥åˆ—è¡¨\nglobal.set('emailNotifications', notifications);\n\n// ä¼ é€’æ•°æ®åˆ°HTTPå“åº”\nmsg.payload = {\n    success: true,\n    notification: notification,\n    totalNotifications: notifications.length\n};\n\nnode.log(`æ–°é‚®ä»¶é€šçŸ¥å·²æ·»åŠ : ${subject}`);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2280,
        "y": 540,
        "wires": [
            [
                "50393f1b8bd47686"
            ]
        ]
    },
    {
        "id": "50393f1b8bd47686",
        "type": "debug",
        "z": "eee4d6c3c137bc07",
        "name": "ç½‘é¡µé€šçŸ¥æ•°æ®",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2520,
        "y": 540,
        "wires": []
    },
    {
        "id": "27d6dcf481b8f2bd",
        "type": "inject",
        "z": "eee4d6c3c137bc07",
        "name": "ğŸ§ª æ‰‹åŠ¨æµ‹è¯•é‚®ä»¶",
        "props": [
            {
                "p": "from",
                "v": "å®¢æˆ·å¼ æ€» <example.customer@example.com>",
                "vt": "str"
            },
            {
                "p": "to",
                "v": "æˆ‘çš„é‚®ç®± <your.email@example.com>",
                "vt": "str"
            },
            {
                "p": "subject",
                "v": "ç´§æ€¥ï¼šé¡¹ç›®å»¶æœŸé—®é¢˜éœ€è¦ç«‹å³è®¨è®º",
                "vt": "str"
            },
            {
                "p": "text",
                "v": "æ‚¨å¥½ï¼Œ\\n\\næˆ‘åˆšæ”¶åˆ°é¡¹ç›®ç»„çš„æŠ¥å‘Šï¼Œè¯´æˆ‘ä»¬çš„é‡è¦é¡¹ç›®å¯èƒ½è¦å»¶æœŸ2å‘¨ã€‚è¿™ä¸ªé¡¹ç›®å¯¹æˆ‘ä»¬Q4çš„ä¸šç»©éå¸¸å…³é”®ï¼Œæˆ‘å¾ˆæ‹…å¿ƒä¼šå½±å“æˆ‘ä»¬çš„åˆä½œå…³ç³»ã€‚\\n\\nèƒ½å¦ä»Šå¤©ä¸‹åˆå®‰æ’ä¸€ä¸ªç´§æ€¥ä¼šè®®è®¨è®ºè§£å†³æ–¹æ¡ˆï¼Ÿæˆ‘ä»¬éœ€è¦å°½å¿«åˆ¶å®šåº”å¯¹è®¡åˆ’ã€‚\\n\\nå¦å¤–ï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“çš„å»¶æœŸåŸå› å’Œä½ ä»¬çš„è¡¥æ•‘æªæ–½ã€‚\\n\\næœŸå¾…æ‚¨çš„å¿«é€Ÿå›å¤ã€‚\\n\\nå¼ æ€»\\n2025å¹´9æœˆ22æ—¥",
                "vt": "str"
            },
            {
                "p": "date",
                "v": "2025-09-22T14:30:00+08:00",
                "vt": "str"
            },
            {
                "p": "messageId",
                "v": "test-urgent-001@example.com",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 430,
        "y": 680,
        "wires": [
            [
                "3fd55876cde28b6d"
            ]
        ]
    },
    {
        "id": "http_notifications_page",
        "type": "http in",
        "z": "eee4d6c3c137bc07",
        "name": "é‚®ä»¶é€šçŸ¥é¡µé¢",
        "url": "/notifications",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 450,
        "y": 920,
        "wires": [
            [
                "build_notifications_html"
            ]
        ]
    },
    {
        "id": "build_notifications_html",
        "type": "template",
        "z": "eee4d6c3c137bc07",
        "name": "æ„å»ºç°ä»£åŒ–HTMLé¡µé¢",
        "field": "payload",
        "fieldType": "msg",
        "format": "html",
        "syntax": "plain",
        "template": "<!DOCTYPE html><html><head><meta charset=\"UTF-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><title>Email AI Assistant Dashboard</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'-apple-system',BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:#0a0b0d;color:#fff;min-height:100vh}.dashboard{display:flex;min-height:100vh}.sidebar{width:80px;background:#1a1b1e;display:flex;flex-direction:column;align-items:center;padding:20px 0;border-right:1px solid #2a2b2e}.logo{width:40px;height:40px;background:#007acc;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;margin-bottom:40px}.nav-item{width:48px;height:48px;background:#2a2b2e;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;cursor:pointer;transition:all 0.3s ease}.nav-item:hover{background:#3a3b3e}.nav-item.active{background:#007acc}.main-content{flex:1;padding:20px 30px;background:#0f1014}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}.greeting h1{font-size:28px;font-weight:600;margin-bottom:5px}.greeting p{color:#888;font-size:16px}.user-controls{display:flex;align-items:center;gap:15px}.refresh-btn{background:#2a2b2e;border:none;color:#fff;padding:10px 16px;border-radius:8px;cursor:pointer;font-size:14px}.refresh-btn:hover{background:#3a3b3e}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}.stat-card{background:#1a1b1e;border-radius:16px;padding:24px;border:1px solid #2a2b2e}.stat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.stat-title{color:#888;font-size:14px}.stat-value{font-size:32px;font-weight:700;margin-bottom:8px}.stat-change{font-size:14px}.positive{color:#10b981}.negative{color:#f59e0b}.content-section{background:#1a1b1e;border-radius:16px;padding:24px;border:1px solid #2a2b2e}.section-header{display:flex;justify-content:between;align-items:center;margin-bottom:20px}.section-title{font-size:20px;font-weight:600}.controls{display:flex;gap:12px;margin-bottom:20px}.btn{background:#2a2b2e;border:none;color:#fff;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px;transition:all 0.3s}.btn:hover{background:#3a3b3e}.btn-primary{background:#007acc}.btn-primary:hover{background:#0066aa}.btn-danger{background:#dc2626}.btn-danger:hover{background:#b91c1c}.email-list{display:flex;flex-direction:column;gap:12px}.email-item{background:#0f1014;border:1px solid #2a2b2e;border-radius:12px;padding:20px;transition:all 0.3s ease}.email-item:hover{border-color:#007acc;transform:translateY(-1px)}.email-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:16px}.email-info h3{font-size:16px;font-weight:600;margin-bottom:4px}.email-info p{color:#888;font-size:14px}.email-time{color:#666;font-size:12px}.email-analysis{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:16px}.analysis-item{background:#1a1b1e;padding:12px 16px;border-radius:8px;border-left:3px solid #007acc}.analysis-label{color:#888;font-size:12px;margin-bottom:4px}.analysis-value{font-size:14px;line-height:1.4}.delete-btn{background:#dc2626;border:none;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px}.delete-btn:hover{background:#b91c1c}.pagination{display:flex;justify-content:space-between;align-items:center;margin-top:20px;padding-top:20px;border-top:1px solid #2a2b2e}.page-info{color:#888;font-size:14px}.empty-state{text-align:center;padding:60px 20px;color:#666}.empty-icon{font-size:48px;margin-bottom:16px}.select-dropdown{background:#2a2b2e;border:1px solid #3a3b3e;color:#fff;padding:8px 12px;border-radius:6px}</style></head><body><div class=\"dashboard\"><div class=\"sidebar\"><div class=\"logo\">EA</div><div class=\"nav-item active\">ğŸ“§</div><div class=\"nav-item\">ğŸ“Š</div><div class=\"nav-item\">âš™ï¸</div></div><div class=\"main-content\"><div class=\"header\"><div class=\"greeting\"><h1>é‚®ä»¶AIåŠ©æ‰‹</h1><p>æ™ºèƒ½é‚®ä»¶åˆ†æä¸å¤„ç†ä¸­å¿ƒ</p></div><div class=\"user-controls\"><button class=\"refresh-btn\" onclick=\"location.reload()\">ğŸ”„ åˆ·æ–°</button></div></div><div class=\"stats-grid\"><div class=\"stat-card\"><div class=\"stat-header\"><span class=\"stat-title\">æ€»é€šçŸ¥æ•°</span><span>ğŸ“¬</span></div><div class=\"stat-value\" id=\"totalCount\">0</div><div class=\"stat-change positive\">+0 ä»Šæ—¥</div></div><div class=\"stat-card\"><div class=\"stat-header\"><span class=\"stat-title\">ä»Šæ—¥å¤„ç†</span><span>âœ…</span></div><div class=\"stat-value\" id=\"todayCount\">0</div><div class=\"stat-change positive\" id=\"todayChange\">+0%</div></div><div class=\"stat-card\"><div class=\"stat-header\"><span class=\"stat-title\">æœ€åæ›´æ–°</span><span>ğŸ•</span></div><div class=\"stat-value\" style=\"font-size:18px\" id=\"lastUpdate\">--:--</div><div class=\"stat-change\">å®æ—¶åŒæ­¥</div></div></div><div class=\"content-section\"><div class=\"section-header\"><div class=\"section-title\">é‚®ä»¶é€šçŸ¥</div></div><div class=\"controls\"><select class=\"select-dropdown\" id=\"pageSize\" onchange=\"changePageSize(this.value)\"><option value=\"5\">5æ¡/é¡µ</option><option value=\"10\" selected>10æ¡/é¡µ</option><option value=\"20\">20æ¡/é¡µ</option></select><button class=\"btn btn-danger\" onclick=\"clearAll()\">æ¸…ç©ºæ‰€æœ‰</button><button class=\"btn\" onclick=\"prevPage()\">ä¸Šä¸€é¡µ</button><button class=\"btn\" onclick=\"nextPage()\">ä¸‹ä¸€é¡µ</button></div><div id=\"notifications\" class=\"email-list\"></div><div class=\"pagination\"><div class=\"page-info\" id=\"pageInfo\">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</div></div></div></div></div><script>let currentPage=1,pageSize=10,allData=[];function loadData(){fetch('/api/notifications').then(r=>r.json()).then(d=>{allData=d.notifications||[];updateStats(d);renderPage()}).catch(e=>console.error('Load error:',e))}function updateStats(data){document.getElementById('totalCount').textContent=data.total||0;document.getElementById('todayCount').textContent=data.todayCount||0;document.getElementById('lastUpdate').textContent=data.lastUpdate||'--:--';const change=data.todayCount>0?`+${Math.round((data.todayCount/data.total)*100)}%`:'0%';document.getElementById('todayChange').textContent=change}function renderPage(){const start=(currentPage-1)*pageSize;const items=allData.slice(start,start+pageSize);const container=document.getElementById('notifications');if(items.length===0){container.innerHTML='<div class=\"empty-state\"><div class=\"empty-icon\">ğŸ“­</div><h3>æš‚æ— é‚®ä»¶é€šçŸ¥</h3><p>AIåˆ†æç»“æœä¼šåœ¨è¿™é‡Œæ˜¾ç¤º</p></div>';updatePageInfo();return}container.innerHTML=items.map(item=>`<div class=\"email-item\"><div class=\"email-header\"><div class=\"email-info\"><h3>${escapeHtml(item.subject||'æ— ä¸»é¢˜')}</h3><p>æ¥è‡ª: ${escapeHtml(item.from||'æœªçŸ¥å‘ä»¶äºº')}</p></div><div style=\"display:flex;align-items:center;gap:12px\"><span class=\"email-time\">${item.displayTime||''}</span><button class=\"delete-btn\" onclick=\"deleteItem('${item.id}')\">åˆ é™¤</button></div></div><div class=\"email-analysis\"><div class=\"analysis-item\" style=\"border-left-color:#10b981\"><div class=\"analysis-label\">æ„å›¾åˆ†æ</div><div class=\"analysis-value\">${escapeHtml(item.analysis?.intent||'æœªåˆ†æ')}</div></div><div class=\"analysis-item\" style=\"border-left-color:#f59e0b\"><div class=\"analysis-label\">å…³é”®ä¿¡æ¯</div><div class=\"analysis-value\">${escapeHtml(item.analysis?.keyInfo||'æ— ')}</div></div><div class=\"analysis-item\" style=\"border-left-color:#dc2626\"><div class=\"analysis-label\">å»ºè®®è¡ŒåŠ¨</div><div class=\"analysis-value\">${escapeHtml(item.analysis?.action||'æ— ')}</div></div></div></div>`).join('');updatePageInfo()}function updatePageInfo(){const totalPages=Math.ceil(allData.length/pageSize);document.getElementById('pageInfo').textContent=`ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ (${allData.length} æ¡è®°å½•)`}function changePageSize(size){pageSize=parseInt(size);currentPage=1;renderPage()}function prevPage(){if(currentPage>1){currentPage--;renderPage()}}function nextPage(){const totalPages=Math.ceil(allData.length/pageSize);if(currentPage<totalPages){currentPage++;renderPage()}}function deleteItem(id){if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡é€šçŸ¥å—ï¼Ÿ')){fetch('/api/notifications/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}).then(r=>r.json()).then(d=>{if(d.success){loadData()}else{alert('åˆ é™¤å¤±è´¥')}}).catch(e=>{console.error('Delete error:',e);alert('åˆ é™¤å¤±è´¥')})}}function clearAll(){if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é€šçŸ¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')){fetch('/api/notifications/clear',{method:'POST'}).then(r=>r.json()).then(d=>{if(d.success){loadData()}else{alert('æ¸…ç©ºå¤±è´¥')}}).catch(e=>{console.error('Clear error:',e);alert('æ¸…ç©ºå¤±è´¥')})}}function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}loadData();setInterval(loadData,30000)</script></body></html>",
        "output": "str",
        "x": 670,
        "y": 920,
        "wires": [
            [
                "http_response_page"
            ]
        ]
    },
    {
        "id": "http_response_page",
        "type": "http response",
        "z": "eee4d6c3c137bc07",
        "name": "è¿”å›HTMLé¡µé¢",
        "statusCode": "",
        "headers": {},
        "x": 880,
        "y": 920,
        "wires": []
    },
    {
        "id": "http_api_notifications",
        "type": "http in",
        "z": "eee4d6c3c137bc07",
        "name": "é€šçŸ¥APIæ¥å£",
        "url": "/api/notifications",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 450,
        "y": 980,
        "wires": [
            [
                "get_notifications_data"
            ]
        ]
    },
    {
        "id": "get_notifications_data",
        "type": "function",
        "z": "eee4d6c3c137bc07",
        "name": "è·å–é€šçŸ¥æ•°æ®",
        "func": "const notifications = global.get('emailNotifications') || [];\nconst today = new Date().toDateString();\nconst todayCount = notifications.filter(n => new Date(n.timestamp).toDateString() === today).length;\nconst lastUpdate = notifications.length > 0 ? new Date(notifications[0].timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'}) : '--:--';\n\nmsg.payload = {\n    success: true,\n    total: notifications.length,\n    todayCount: todayCount,\n    lastUpdate: lastUpdate,\n    notifications: notifications\n};\n\nmsg.statusCode = 200;\nmsg.headers = {'Content-Type': 'application/json'};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 980,
        "wires": [
            [
                "http_response_api"
            ]
        ]
    },
    {
        "id": "http_response_api",
        "type": "http response",
        "z": "eee4d6c3c137bc07",
        "name": "è¿”å›APIæ•°æ®",
        "statusCode": "",
        "headers": {},
        "x": 870,
        "y": 980,
        "wires": []
    },
    {
        "id": "http_delete_single",
        "type": "http in",
        "z": "eee4d6c3c137bc07",
        "name": "åˆ é™¤å•ä¸ªé€šçŸ¥",
        "url": "/api/notifications/delete",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 450,
        "y": 1040,
        "wires": [
            [
                "delete_single_notification"
            ]
        ]
    },
    {
        "id": "delete_single_notification",
        "type": "function",
        "z": "eee4d6c3c137bc07",
        "name": "åˆ é™¤å•ä¸ªé€šçŸ¥å¤„ç†",
        "func": "const { id } = msg.payload;\nif (!id) {\n    msg.payload = { success: false, error: 'ç¼ºå°‘é€šçŸ¥ID' };\n    msg.statusCode = 400;\n    return msg;\n}\n\nlet notifications = global.get('emailNotifications') || [];\nconst originalLength = notifications.length;\nnotifications = notifications.filter(n => n.id != id);\nglobal.set('emailNotifications', notifications);\n\nif (notifications.length < originalLength) {\n    msg.payload = { success: true, message: 'é€šçŸ¥åˆ é™¤æˆåŠŸ', remainingCount: notifications.length };\n    node.log(`é€šçŸ¥åˆ é™¤æˆåŠŸ: ${id}`);\n} else {\n    msg.payload = { success: false, error: 'æœªæ‰¾åˆ°æŒ‡å®šé€šçŸ¥' };\n}\n\nmsg.statusCode = 200;\nmsg.headers = { 'Content-Type': 'application/json' };\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 1040,
        "wires": [
            [
                "http_response_delete"
            ]
        ]
    },
    {
        "id": "http_clear_all",
        "type": "http in",
        "z": "eee4d6c3c137bc07",
        "name": "æ¸…ç©ºæ‰€æœ‰é€šçŸ¥",
        "url": "/api/notifications/clear",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 450,
        "y": 1100,
        "wires": [
            [
                "clear_all_notifications"
            ]
        ]
    },
    {
        "id": "clear_all_notifications",
        "type": "function",
        "z": "eee4d6c3c137bc07",
        "name": "æ¸…ç©ºæ‰€æœ‰é€šçŸ¥å¤„ç†",
        "func": "const notifications = global.get('emailNotifications') || [];\nconst clearedCount = notifications.length;\nglobal.set('emailNotifications', []);\n\nmsg.payload = { success: true, message: `å·²æ¸…ç©ºæ‰€æœ‰é€šçŸ¥`, clearedCount: clearedCount };\nmsg.statusCode = 200;\nmsg.headers = { 'Content-Type': 'application/json' };\nnode.log(`æ‰€æœ‰é€šçŸ¥å·²æ¸…ç©º: ${clearedCount}æ¡`);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 1100,
        "wires": [
            [
                "http_response_delete"
            ]
        ]
    },
    {
        "id": "http_response_delete",
        "type": "http response",
        "z": "eee4d6c3c137bc07",
        "name": "è¿”å›åˆ é™¤ç»“æœ",
        "statusCode": "",
        "headers": {},
        "x": 920,
        "y": 1070,
        "wires": []
    },
    {
        "id": "7b8558cce3b3526f",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-node-email": "3.1.0"
        }
    }
]